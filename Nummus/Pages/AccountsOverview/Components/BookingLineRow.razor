@using Nummus.Service
@using Nummus.Data
@inject FormatService FormatService
@inject IBookingLineService BookingLineService
<div class="flex flex-align-center">
    <div>
        @BookingLine.BookingTime.ToString("dd/MM/yy HH:mm")
    </div>
    <div class="flex-grow padding-left-1">
        @BookingLine.BookingText
    </div>
    <div class="@(BookingLine.Amount < 0 ? "negative-colour" : "positive-colour")">
        @FormatService.FormatToLocalCurrency(BookingLine.Amount)
    </div>
    <div>
        <MatIconButton Class="force-white-text margin-right"
                       OnClick="@OpenBookingLineDialog">
            <MatIcon Icon="edit" />
        </MatIconButton>
    </div>
</div>

<MatDialog IsOpen="@_editBookingLineDialogOpen">
    <MatDialogTitle Class="force-white-text">Edit Booking Line</MatDialogTitle>
    <MatDialogContent>
        <BookingLineForm BookingLine="_editedBookingLine" />
    </MatDialogContent>
    <MatDialogActions>
        <MatButton OnClick="@CloseBookingLineDialog">Cancel</MatButton>
        <MatButton OnClick="@SaveBookingLine">Save</MatButton>
    </MatDialogActions>
</MatDialog>

@code {
    [Parameter]
    public BookingLine BookingLine { get; set; }

    [Parameter]
    public EventCallback OnBookingLineChange { get; set; }

    private BookingLine _editedBookingLine = new();

    private bool _editBookingLineDialogOpen;
    
    
    private void OpenBookingLineDialog() {
        _editBookingLineDialogOpen = true;
    }

    private void CloseBookingLineDialog() {
        ResetChanges();
        _editBookingLineDialogOpen = false;
    }

    private void SaveBookingLine() {
        BookingLine.BookingText = _editedBookingLine.BookingText;
        BookingLine.Amount = _editedBookingLine.Amount;
        BookingLine.BookingTime = _editedBookingLine.BookingTime;
        BookingLine.Category = _editedBookingLine.Category;
        BookingLineService.SaveBookingLine(BookingLine);
        OnBookingLineChange.InvokeAsync();
        _editBookingLineDialogOpen = false;
    }

    protected override void OnParametersSet() {
        ResetChanges();
        base.OnParametersSet();
    }

    private void ResetChanges() {
        _editedBookingLine.BookingText = BookingLine.BookingText;
        _editedBookingLine.Amount = BookingLine.Amount;
        _editedBookingLine.BookingTime = BookingLine.BookingTime;
        _editedBookingLine.Category = BookingLine.Category;
    }
}